<!DOCTYPE HTML>
<html>
  <head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Cache-Control" content="no-siteapp" />
    <title>网站概况</title>
    <script type="text/javascript">
    		var idSite = "";
    		var t = "";
    </script>
    <script type="text/javascript" src="../common/js/common.js"></script>
    <style type="text/css">
    		.main-content {border-left: none;border-right: none;padding: 15px;background-color: #ececec;}
		.table-list {border: 1px solid #dedede;background-color: #fff;}
		.today-flow {color: black;font-weight: bold;padding-bottom: 0px;font-size: 16px;padding-left: 10px;}
		.overview-gap {clear: both; background-color: #ececec; height: 16px;}
		.overview-detail{}
		.control-bar-wrapper{border: 1px solid #dfe0e0; padding: 0;background-color: #fff;}
		.index-site{background-color: #ececec; height: 810px;}
		.table-grid-item {margin-top: 1px; background-color: #fff; height: 392px;}
		#today-flow-table tr.thead td{border-top:0px;} 
    </style>
  </head>
  
  <body>
	<div class="main-content">
		<!-- 今日流量 -->
		<div class="table-list">
			<table id="today-flow-table" class="table table-hover">
				<caption class="today-flow">今日流量</caption>
				
				<tbody>
					<tr class="thead" style="color: #777;" align="center">
						<td></td>
						<td><div data-toggle="tooltip" data-placement="auto" title="页面被查看的次数。用户多次打开同一页面，浏览量值累计。">浏览量(PV)</div></td>
						<td><div data-toggle="tooltip" data-placement="auto" title="网站独立访客数量。即使一天之内多次访问网站也只会被统计一次。">访客数(UV)</div></td>
						<td><div data-toggle="tooltip" data-placement="auto" title="访客第一次访问你的网站或者距离上次访问时间超过30分钟，会被统计为新的访问。">访问</div></td>
						<td><div data-toggle="tooltip" data-placement="auto" title="登录你的网站的用户数量。它是具有用户ID组唯一活跃用户的数量（通过追踪码函数'setUserId'）。">用户数</div></td>
						<td><div data-toggle="tooltip" data-placement="auto" title="只查看单个页面的百分比，即访客直接从入口页面离开网站。">跳出率</div></td>
						<td><div data-toggle="tooltip" data-placement="auto" title="访客在一次访问中，平均打开网站的时长。">平均访问时长(秒)</div></td>
					</tr>
					<tr class="today" align="center">
						<td colspan="7"></td>
					</tr>
					<tr class="yesterday" align="center">
						<td colspan="7"></td>
					</tr>
				</tbody>
			</table>
		</div>
		<div class="overview-gap"></div>
		<div class="overview-detail">
			<div id="DateSelectBar">
				<div class="control-bar-wrapper">
					<div id="dateDiv" class="btn-group">
						<button type="button" class="btn btn-default" data="last1" onclick="changeDate('last1')">今天</button>
						<button type="button" class="btn btn-default" data="previous1" onclick="changeDate('previous1')">昨天</button>
						<button type="button" class="btn btn-default active" data="last7" onclick="changeDate('last7')">最近7天</button>
						<button type="button" class="btn btn-default" data="last30" onclick="changeDate('last30')">最近30天</button>
						<input id="date" type="hidden" value="last7" />
					</div>
				</div>
			</div>
			<div class="overview-gap"></div>
			<div class="index-site">
				<div class="first-row">
					<div style="float: left;width: 49%;">
						<div class="table-grid-item">
							<div class="title" style="height: 55px;">
								<div style="float: left;font-weight: bold;font-size: 14px;padding: 5px 0 0 10px;">访客趋势图</div>
								<div style="float: right;padding: 5px 10px 0 0;">
									<a href="http://www.baidu.com"><span class="glyphicon glyphicon-chevron-right"></span></a>
								</div>
								<div style="clear: both;"></div>
								<div id="btn_group" class="btn-group" style="padding: 5px 0 0 10px;">
									<button id="btn_pv" type="button" class="btn btn-default btn-xs active" onclick="visitTendency_btn1('pv');">浏览量(PV)</button>
									<button id="btn_uv" type="button" class="btn btn-default btn-xs" onclick="visitTendency_btn1('uv');">访客数(UV)</button>
									<div class="btn-group">
										<button id="btn_other" type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
											<span id="visitTendency_btn_text">其他</span>
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu">
											<li><a id="btn_visit" href="javascript:visitTendency_btn2('visit');">访问</a></li>
											<li><a id="btn_user" href="javascript:visitTendency_btn2('user');">用户数</a></li>
											<li><a id="btn_br" href="javascript:visitTendency_btn2('br');">跳出率</a></li>
											<li><a id="btn_at" href="javascript:visitTendency_btn2('at');">平均访问时长(秒)</a></li>
										</ul>
								  </div>
								  <input type="hidden" id="visitTendencyIndex" value="pv"/>
								</div>
							</div>
							
							<div id="visitTendency" style="width: '49%';height:350px;"></div>
						</div>
					</div>
					<div style="float: right;width: 49%;">
						<div class="table-grid-item">
							<div id="visit2" style="width: '49%';height:392px;"></div>
						</div>
					</div>
				</div>
				<div class="overview-gap"></div>
				<div class="second-row">
					<div style="float: left;width: 49%;">
						<div class="table-grid-item">
							<div id="visit3" style="width: '49%';height:392px;"></div>
						</div>
					</div>
					<div style="float: right;width: 49%;">
						<div class="table-grid-item">
							<div id="visit4" style="width: '49%';height:392px;"></div>
						</div>
					</div>
				</div>
				
			</div>
		</div>
	</div>
	
  </body>
  
<script type="text/javascript">
    		//访问趋势图
    		//http://192.168.169.129/piwik/index.php?module=API&method=VisitsSummary.getVisits&idSite=1&period=day&date=last7&format=json&token_auth=e71ba827b18991f694bc0929508c3dfb&translateColumnNames=1
    		function changeMenu(){
    			parent.changeMenu("menu-child-33");
    		}
    		
    		$(document).ready(function(){
    			idSite = getQueryString("siteId");
    			t = getQueryString("t");
    			// 加载今日流量
    			$("[data-toggle='tooltip']").tooltip();
    			getTodayFlow();
    			// 加载访客趋势图
    			var visitTendencyChart = null;
    			init_visit();
    			ajax_visit();
    		});
    		
    		// 今日流量
    		function getTodayFlow(){
    			var p_t1 = "module=API&method=MultiSites.getOne&idSite="+idSite+"&period=day&date=today&format=JSON&token_auth="+t;
    			var p_t2 = "module=API&method=VisitsSummary.get&idSite="+idSite+"&period=day&date=today&format=JSON&token_auth="+t;
    			var p_y1 = "module=API&method=MultiSites.getOne&idSite="+idSite+"&period=day&date=yesterday&format=JSON&token_auth="+t;
    			var p_y2 = "module=API&method=VisitsSummary.get&idSite="+idSite+"&period=day&date=yesterday&format=JSON&token_auth="+t;
    			var urls = new Array();
    			urls.push(encodeURI(p_t1));
    			urls.push(encodeURI(p_t2));
    			urls.push(encodeURI(p_y1));
    			urls.push(encodeURI(p_y2));
    			var p = getBulkRequestParam(urls);
    			ajax_jsonp(piwik_url, p, function(data){
    				data = eval(data);
    				var ms_t = data[0];
    				var vs_t = data[1];
    				var ms_y = data[2];
    				var vs_y = data[3];
    				var todayTr = "<td>今日</td><td>"+ms_t["nb_pageviews"]+"</td><td>"+vs_t["nb_uniq_visitors"]+"</td><td>"+vs_t["nb_visits"]+"</td><td>"+vs_t["nb_users"]+"</td><td>"+vs_t["bounce_rate"]+"</td><td>"+vs_t["avg_time_on_site"]+"</td>";
    				var yesterdayTr = "<td>昨日</td><td>"+ms_y["nb_pageviews"]+"</td><td>"+vs_y["nb_uniq_visitors"]+"</td><td>"+vs_y["nb_visits"]+"</td><td>"+vs_y["nb_users"]+"</td><td>"+vs_y["bounce_rate"]+"</td><td>"+vs_y["avg_time_on_site"]+"</td>";
    				$("#today-flow-table tr.today").html(todayTr);
    				$("#today-flow-table tr.yesterday").html(yesterdayTr);
    			});
    		}
    		
    		// 时间切换
		function changeDate(date){
			$("#dateDiv .btn").removeClass("active");
			$("#dateDiv .btn[data="+date+"]").addClass("active");
			$("#date").val(date);
			ajax_visit();
		}
		// 访客趋势图start
    		// 初始化访客趋势图
    		function init_visit(){
	        visitTendencyChart = echarts.init(document.getElementById('visitTendency'));
	        var option = {
	            title: {},
			    tooltip: {trigger: 'axis',},
			    legend: {bottom : '6%'},
			    grid: {left: '8%',right: '8%',top: '8%',containLabel: true},
			    toolbox: {feature: {}},
			    xAxis: {type: 'category',boundaryGap: false},
			    yAxis: {type: 'value'},
			    series: []
	      	};
	        visitTendencyChart.setOption(option);
    		}
    		//加载访客趋势图
    		function ajax_visit(){
    			var date = $("#date").val(); // 日期
    			var visitTendencyIndex = $("#visitTendencyIndex").val(); // 指标
    			var param = {};
    			var option = {};
    			visitTendencyChart.showLoading();
    			// 浏览量(PV)
    			if("pv"==visitTendencyIndex){
    				param = {module:"API",method:"MultiSites.getOne",idSite:idSite,period:"day",date:date,format:"json",token_auth:t};
    				ajax_jsonp(piwik_url, param, function(data){
    					data = eval(data);
    					var categories = new Array();
					var datas = new Array();
					for(var k in data){
						categories.push(k);
						datas.push(data[k].nb_pageviews);
					}
					option = {
						legend: {data:["浏览量(PV)"]},
						tooltip:{formatter:function(params){return params[0].name + ' <br/>' + params[0].seriesName + ": " + params[0].value;}},
				    		xAxis: {data:categories},
				    		yAxis: {axisLabel:{formatter: '{value}'}},
				    		series:[{name:'浏览量(PV)',type:'line',stack: '浏览量(PV)',itemStyle:{normal:{color: '#87CEEB',lineStyle:{color:'#87CEEB'}}},
				            areaStyle: {normal: {color:'#87CEEB'}},data:datas
				    		}]
					};
					visitTendencyChart.hideLoading();
					visitTendencyChart.setOption(option);
    				});
    			}
    			// 访客数(UV)
    			else if("uv"==visitTendencyIndex){
    				param = {module:"API",method:"VisitsSummary.get",idSite:idSite,period:"day",date:date,format:"json",token_auth:t,columns:"nb_uniq_visitors"};
    				ajax_jsonp(piwik_url, param, function(data){
    					data = eval(data);
    					var categories = new Array();
					var datas = new Array();
					for(var k in data){
						categories.push(k);
						datas.push(data[k]);
					}
					option = {
						legend: {data:["访客数(UV)"]},
						tooltip:{formatter:function(params){return params[0].name + ' <br/>' + params[0].seriesName + ": " + params[0].value;}},
				    		xAxis: {data:categories},
				    		yAxis: {axisLabel:{formatter: '{value}'}},
				    		series:[{name:'访客数(UV)',type:'line',stack: '访客数(UV)',itemStyle:{normal:{color: '#87CEEB',lineStyle:{color:'#87CEEB'}}},
				            areaStyle: {normal: {color:'#87CEEB'}},data:datas
				    		}]
					};
					visitTendencyChart.hideLoading();
					visitTendencyChart.setOption(option);
    				});
    			}
    			// 访问
    			else if("visit" == visitTendencyIndex){
    				param = {module:"API",method:"VisitsSummary.get",idSite:idSite,period:"day",date:date,format:"json",token_auth:t,columns:"nb_visits"};
    				ajax_jsonp(piwik_url, param, function(data){
    					data = eval(data);
    					var categories = new Array();
					var datas = new Array();
					for(var k in data){
						categories.push(k);
						datas.push(data[k]);
					}
					option = {
						legend: {data:["访问"]},
						tooltip:{formatter:function(params){return params[0].name + ' <br/>' + params[0].seriesName + ": " + params[0].value;}},
				    		xAxis: {data:categories},
				    		yAxis: {axisLabel:{formatter: '{value}'}},
				    		series:[{name:'访问',type:'line',stack: '访问',itemStyle:{normal:{color: '#87CEEB',lineStyle:{color:'#87CEEB'}}},
				            areaStyle: {normal: {color:'#87CEEB'}},data:datas
				    		}]
					};
					visitTendencyChart.hideLoading();
					visitTendencyChart.setOption(option);
    				});
    			}
    			// 用户数
    			else if("user" == visitTendencyIndex){
    				param = {module:"API",method:"VisitsSummary.get",idSite:idSite,period:"day",date:date,format:"json",token_auth:t,columns:"nb_users"};
    				ajax_jsonp(piwik_url, param, function(data){
    					data = eval(data);
    					var categories = new Array();
					var datas = new Array();
					for(var k in data){
						categories.push(k);
						datas.push(data[k]);
					}
					option = {
						legend: {data:["用户数"]},
						tooltip:{formatter:function(params){return params[0].name + ' <br/>' + params[0].seriesName + ": " + params[0].value;}},
				    		xAxis: {data:categories},
				    		yAxis: {axisLabel:{formatter: '{value}'}},
				    		series:[{name:'用户数',type:'line',stack: '用户数',itemStyle:{normal:{color: '#87CEEB',lineStyle:{color:'#87CEEB'}}},
				            areaStyle: {normal: {color:'#87CEEB'}},data:datas
				    		}]
					};
					visitTendencyChart.hideLoading();
					visitTendencyChart.setOption(option);
    				});
    			}
    			// 跳出率
    			else if("br" == visitTendencyIndex){
    				param = {module:"API",method:"VisitsSummary.get",idSite:idSite,period:"day",date:date,format:"json",token_auth:t,columns:"bounce_rate"};
    				ajax_jsonp(piwik_url, param, function(data){
    					data = eval(data);
    					var categories = new Array();
					var datas = new Array();
					for(var k in data){
						categories.push(k);
						var br = data[k];
						if(br instanceof Array){
							br = "0";
						}else{
							br = br.substr(0,br.length-1);
						}
						datas.push(br);
					}
					option = {
						legend: {data:["跳出率"]},
						tooltip:{formatter:function(params){return params[0].name + ' <br/>' + params[0].seriesName + ": " + params[0].value + '%';}},
				    		xAxis: {data:categories},
				    		yAxis: {axisLabel:{formatter: '{value}%'}},
				    		series:[{name:'跳出率',type:'line',stack: '跳出率',itemStyle:{normal:{color: '#87CEEB',lineStyle:{color:'#87CEEB'}}},
				            areaStyle: {normal: {color:'#87CEEB'}},data:datas
				    		}]
					};
					visitTendencyChart.hideLoading();
					visitTendencyChart.setOption(option);
    				});
    			}
    			// 平均访问时长(秒)
    			else if("at" == visitTendencyIndex){
    				param = {module:"API",method:"VisitsSummary.get",idSite:idSite,period:"day",date:date,format:"json",token_auth:t,columns:"avg_time_on_site"};
    				ajax_jsonp(piwik_url, param, function(data){
    					data = eval(data);
    					var categories = new Array();
					var datas = new Array();
					for(var k in data){
						categories.push(k);
						var at = data[k];
						if(at instanceof Array){
							at = 0;
						}
						datas.push(at);
					}
					option = {
						legend: {data:["平均访问时长(秒)"]},
						tooltip:{formatter:function(params){return params[0].name + ' <br/>' + params[0].seriesName + ": " + params[0].value;}},
				    		xAxis: {data:categories},
				    		yAxis: {axisLabel:{formatter: '{value}'}},
				    		series:[{name:'平均访问时长(秒)',type:'line',stack: '平均访问时长(秒)',itemStyle:{normal:{color: '#87CEEB',lineStyle:{color:'#87CEEB'}}},
				            areaStyle: {normal: {color:'#87CEEB'}},data:datas
				    		}]
					};
					visitTendencyChart.hideLoading();
					visitTendencyChart.setOption(option);
    				});
    			}
    			/**
    			var param_visits = "module=API&method=VisitsSummary.getVisits&idSite="+idSite+"&period=day&date="+date+"&format=json&token_auth="+t+"&translateColumnNames=1";
    			var param_uniqueVisitors = "module=API&method=VisitsSummary.getUniqueVisitors&idSite="+idSite+"&period=day&date="+date+"&format=json&token_auth="+t;
    			var urls = new Array();
    			urls.push(encodeURI(param_visits));
    			urls.push(encodeURI(param_uniqueVisitors));
    			var param = {module:"API",method:"API.getBulkRequest",format:"json",urls:urls};
    			visitTendencyChart.showLoading();
    			ajax_jsonp(piwik_url, param, function(data){
    				data = eval(data);
				var categories = new Array();
				var datas = new Array();
				var visit_data = data[0];
				for(var cat in visit_data){
					categories.push(cat);
					datas.push(visit_data[cat]);
				}
				var uniqueVisitors_data = data[1];
				var categories1 = new Array();
				var datas1 = new Array();
				for(var cat1 in uniqueVisitors_data){
					categories1.push(cat1);
					datas1.push(uniqueVisitors_data[cat1]);
				}
				var option = {
					legend: {
			        		data:['访问',"唯一访客"]
			    		},
			    		xAxis: {
			    			data:categories
			    		},
			    		series:[{
			    			name:'访问',
			            type:'line',
			            stack: '访问',
			            areaStyle: {normal: {}},
			            data:datas
			    		},{
			    			name:'唯一访客',
			            type:'line',
			            stack: '唯一访客',
			            areaStyle: {normal: {}},
			            data:datas1
			    		}]
				};
				visitTendencyChart.hideLoading();
				visitTendencyChart.setOption(option);
    			});
    			*/
    		}
    		
    		// 浏览量、访客数按钮点击事件
		function visitTendency_btn1(index){
			$("#visitTendency_btn_text").text("其他");
			$("#visitTendencyIndex").val(index);
			$("#btn_group button").removeClass("active");
			$("#btn_"+index).addClass("active");
			// 刷新访客趋势图
			ajax_visit();
		}
		// 访客趋势图其他按钮点击事件
		function visitTendency_btn2(index){
			$("#visitTendency_btn_text").text($("#btn_"+index).text());
			$("#visitTendencyIndex").val(index);
			$("#btn_group button").removeClass("active");
			$("#btn_other").addClass("active");
			// 刷新访客趋势图
			ajax_visit();
		}
		// 访客趋势图end
    </script>
</html>
